<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .button-container { display: flex; justify-content: space-between; margin-top: 20px; }
        button { padding: 10px 20px; }
        .context { color: blue;}
        .debug { color: gray; font-size: 9px; }
    </style>
</head>
<body>
    <div id="templateData" style="display:none"><?= JSON.stringify(data) ?></div>
    <details>
        <summary>Debug Info</summary>
        <div id="debug"><?= JSON.stringify(data) ?></div>
    </details>
    <div id="result"></div>
    <div id="error"></div>
    <div class="button-container">
        <button onclick="google.script.host.close()">Cancel</button>
        <button onclick="acceptCompletion()">Accept</button>
    </div>

    <script>
        const rawData = document.getElementById('templateData').textContent;
        const data = JSON.parse(rawData);

        function loadResult() {
            const result = document.getElementById('result');
            const beforeDiv = data.before ? createContextDiv(data.before) : null;
            const newDiv = createNewDiv(data.new);
            const afterDiv = data.after ? createContextDiv(data.after) : null;

            if (beforeDiv) result.appendChild(beforeDiv);
            result.appendChild(newDiv);
            if (afterDiv) result.appendChild(afterDiv);
        }

        function createContextDiv(text) {
            const div = document.createElement('div');
            div.className = 'context';
            div.innerHTML = text;
            return div;
        }

        function createNewDiv(text) {
            const div = document.createElement('textarea');
            div.id = 'modifiedCompletion';
            div.value = text;
            div.rows = Math.ceil(text.length / 50) || 1;
            div.cols = 50;
            return div;
        }

        function handleError(error) {
            console.error(error);
            document.getElementById('error').innerHTML = error;
        }

        function acceptCompletion() {
            const modifiedCompletion = document.getElementById('modifiedCompletion').value;
            console.log('accepting completion:', modifiedCompletion);
            
            google.script.run
            .withSuccessHandler(function(data) {
                google.script.host.close();
              })
              .withFailureHandler(handleError)
              .insertTextAtCursor(modifiedCompletion);
        }

        onload = loadResult;
    </script>
</body>
</html>
